<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenClaw Metrics</title>
    <style>
      :root {
        --bg: #08111f;
        --panel: #122038;
        --line: #263852;
        --text: #e5edf8;
        --muted: #9bb1cc;
        --c1: #ff6b6b;
        --c2: #ffd166;
        --c3: #20c997;
        --c4: #5da9ff;
        --c5: #ff9f1c;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--text);
        font-family: "SF Mono", Menlo, Consolas, monospace;
        background: radial-gradient(circle at top left, #1a2d4a, var(--bg) 56%);
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      h1 {
        margin: 0 0 10px;
        font-size: 24px;
      }

      .sub {
        color: var(--muted);
        font-size: 12px;
        margin-bottom: 14px;
      }

      .toolbar {
        display: grid;
        gap: 8px;
        grid-template-columns: 130px 130px 1fr 1fr 100px;
        background: color-mix(in srgb, var(--panel) 92%, black);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
      }

      label {
        display: grid;
        gap: 4px;
        font-size: 11px;
        color: var(--muted);
      }

      select,
      input,
      button {
        color: var(--text);
        background: #0e1a2f;
        border: 1px solid var(--line);
        border-radius: 8px;
        font: inherit;
        padding: 7px;
      }

      button {
        cursor: pointer;
      }

      .cards {
        margin-top: 12px;
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }

      .card {
        background: color-mix(in srgb, var(--panel) 90%, black);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
      }

      .card .label {
        font-size: 11px;
        color: var(--muted);
      }

      .card .value {
        margin-top: 4px;
        font-size: 20px;
      }

      .grid {
        margin-top: 12px;
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .panel {
        background: color-mix(in srgb, var(--panel) 90%, black);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px;
      }

      .panel h2 {
        margin: 0 0 8px;
        font-size: 13px;
        color: var(--muted);
        font-weight: 500;
      }

      .legend {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }

      .legend span {
        font-size: 11px;
        color: var(--muted);
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        display: inline-block;
      }

      .chart {
        width: 100%;
        height: 220px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: #0b162a;
      }

      .status {
        margin-top: 10px;
        color: var(--muted);
        font-size: 11px;
      }

      a {
        color: #9ec9ff;
      }

      @media (max-width: 980px) {
        .cards {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .grid {
          grid-template-columns: 1fr;
        }
        .toolbar {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Control Plane Metrics</h1>
      <div class="sub">Governance trends from audit events. <a href="/ui/approvals.html">Approvals queue</a> | <a href="/ui/policies.html">Policy rules</a> | <a href="/ui/audit.html">Audit log</a></div>

      <section class="toolbar">
        <label>
          Window
          <select id="window">
            <option value="30">30m</option>
            <option value="60" selected>60m</option>
            <option value="180">180m</option>
            <option value="360">360m</option>
            <option value="720">720m</option>
          </select>
        </label>
        <label>
          Bucket
          <select id="bucket">
            <option value="1">1m</option>
            <option value="5" selected>5m</option>
            <option value="10">10m</option>
            <option value="15">15m</option>
            <option value="30">30m</option>
          </select>
        </label>
        <label>
          Auto-refresh
          <select id="refresh">
            <option value="0">off</option>
            <option value="5000" selected>5s</option>
            <option value="10000">10s</option>
            <option value="30000">30s</option>
          </select>
        </label>
        <label>
          API Key (optional)
          <input id="apiKey" type="password" placeholder="x-api-key for /v1 auth" />
        </label>
        <label>
          Actions
          <button id="refreshBtn" type="button">Refresh</button>
        </label>
      </section>

      <section class="cards">
        <article class="card" style="border-color:var(--c3)"><div class="label" style="color:var(--c3)">Est. Savings</div><div class="value" id="cSavings" style="color:var(--c3)">-</div></article>
        <article class="card" style="border-color:var(--c3)"><div class="label" style="color:var(--c3)">Savings %</div><div class="value" id="cSavingsPct" style="color:var(--c3)">-</div></article>
        <article class="card"><div class="label">Est. Cost</div><div class="value" id="cCost">-</div></article>
        <article class="card"><div class="label">Pending</div><div class="value" id="cPending">-</div></article>
        <article class="card"><div class="label">Policy Deny</div><div class="value" id="cDeny">-</div></article>
        <article class="card"><div class="label">Outbound Block</div><div class="value" id="cOutbound">-</div></article>
        <article class="card"><div class="label">Redaction Events</div><div class="value" id="cRedaction">-</div></article>
        <article class="card"><div class="label">Premium Routes</div><div class="value" id="cPremium">-</div></article>
      </section>

      <section class="grid">
        <article class="panel">
          <h2>Security Trend</h2>
          <div class="legend">
            <span><i class="dot" style="background:var(--c1)"></i>Policy Deny</span>
            <span><i class="dot" style="background:var(--c2)"></i>Outbound Block</span>
            <span><i class="dot" style="background:var(--c5)"></i>Redaction Events</span>
          </div>
          <svg class="chart" id="chartSecurity" viewBox="0 0 1000 220" preserveAspectRatio="none"></svg>
        </article>

        <article class="panel">
          <h2>Approval Flow</h2>
          <div class="legend">
            <span><i class="dot" style="background:var(--c4)"></i>Created</span>
            <span><i class="dot" style="background:var(--c3)"></i>Decided</span>
          </div>
          <svg class="chart" id="chartApprovals" viewBox="0 0 1000 220" preserveAspectRatio="none"></svg>
        </article>

        <article class="panel">
          <h2>Routing Mix</h2>
          <div class="legend">
            <span><i class="dot" style="background:var(--c4)"></i>Local</span>
            <span><i class="dot" style="background:var(--c3)"></i>Cheap</span>
            <span><i class="dot" style="background:var(--c1)"></i>Premium</span>
          </div>
          <svg class="chart" id="chartRouting" viewBox="0 0 1000 220" preserveAspectRatio="none"></svg>
        </article>

        <article class="panel">
          <h2>Cost Trend</h2>
          <div class="legend">
            <span><i class="dot" style="background:var(--c3)"></i>Savings</span>
            <span><i class="dot" style="background:var(--c1)"></i>Cost</span>
          </div>
          <svg class="chart" id="chartCost" viewBox="0 0 1000 220" preserveAspectRatio="none"></svg>
        </article>

        <article class="panel">
          <h2>Policy Decisions</h2>
          <div class="legend">
            <span><i class="dot" style="background:var(--c3)"></i>Allow</span>
            <span><i class="dot" style="background:var(--c2)"></i>Ask</span>
            <span><i class="dot" style="background:var(--c1)"></i>Deny</span>
          </div>
          <svg class="chart" id="chartPolicy" viewBox="0 0 1000 220" preserveAspectRatio="none"></svg>
        </article>
      </section>

      <div class="status" id="status">Loading...</div>
    </main>

    <script>
      const els = {
        window: document.getElementById("window"),
        bucket: document.getElementById("bucket"),
        refresh: document.getElementById("refresh"),
        apiKey: document.getElementById("apiKey"),
        refreshBtn: document.getElementById("refreshBtn"),
        status: document.getElementById("status"),
        cSavings: document.getElementById("cSavings"),
        cSavingsPct: document.getElementById("cSavingsPct"),
        cCost: document.getElementById("cCost"),
        cPending: document.getElementById("cPending"),
        cDeny: document.getElementById("cDeny"),
        cOutbound: document.getElementById("cOutbound"),
        cRedaction: document.getElementById("cRedaction"),
        cPremium: document.getElementById("cPremium"),
      };

      let timer = null;

      function setStatus(message, isError = false) {
        els.status.textContent = message;
        els.status.style.color = isError ? "#ff6b6b" : "#9bb1cc";
      }

      function linePath(values, width, height, max) {
        if (!values.length) {
          return "";
        }
        const safeMax = max <= 0 ? 1 : max;
        const step = values.length <= 1 ? width : width / (values.length - 1);
        return values
          .map((v, i) => {
            const x = i * step;
            const y = height - (v / safeMax) * height;
            return `${i === 0 ? "M" : "L"}${x.toFixed(2)} ${y.toFixed(2)}`;
          })
          .join(" ");
      }

      function renderChart(svgId, series) {
        const svg = document.getElementById(svgId);
        const width = 1000;
        const height = 220;
        const max = Math.max(1, ...series.flatMap((s) => s.values));

        const grid = [];
        for (let i = 1; i <= 4; i += 1) {
          const y = (height / 5) * i;
          grid.push(`<line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="#24364f" stroke-width="1" />`);
        }

        const paths = series
          .map((s) => {
            const d = linePath(s.values, width, height, max);
            return `<path d="${d}" fill="none" stroke="${s.color}" stroke-width="2.2" />`;
          })
          .join("");

        svg.innerHTML = `
          <rect x="0" y="0" width="${width}" height="${height}" fill="#0b162a" />
          ${grid.join("")}
          ${paths}
        `;
      }

      async function getJson(url) {
        const key = (els.apiKey.value || "").trim();
        const headers = key ? { "x-api-key": key } : undefined;
        const response = await fetch(url, { headers });
        const body = await response.json();
        if (!response.ok) {
          throw new Error(body.error || `Request failed (${response.status})`);
        }
        return body;
      }

      function updateSummary(summary) {
        els.cSavings.textContent = "$" + (summary.routing.estimatedSavings || 0).toFixed(4);
        els.cSavingsPct.textContent = (summary.routing.savingsPercentage || 0).toFixed(1) + "%";
        els.cCost.textContent = "$" + (summary.routing.estimatedCost || 0).toFixed(4);
        els.cPending.textContent = String(summary.approvals.pending);
        els.cDeny.textContent = String(summary.policy.deny);
        els.cOutbound.textContent = String(summary.security.outboundBlocked);
        els.cRedaction.textContent = String(summary.security.redactionEvents);
        els.cPremium.textContent = String(summary.routing.byTier.premium);
      }

      function updateCharts(timeseries) {
        const b = timeseries.buckets || [];

        renderChart("chartSecurity", [
          { color: "var(--c1)", values: b.map((x) => x.policy.deny || 0) },
          { color: "var(--c2)", values: b.map((x) => x.security.outboundBlocked || 0) },
          { color: "var(--c5)", values: b.map((x) => x.security.redactionEvents || 0) },
        ]);

        renderChart("chartApprovals", [
          { color: "var(--c4)", values: b.map((x) => x.approvals.created || 0) },
          { color: "var(--c3)", values: b.map((x) => x.approvals.decided || 0) },
        ]);

        renderChart("chartCost", [
          { color: "var(--c3)", values: b.map((x) => x.routing.estimatedSavings || 0) },
          { color: "var(--c1)", values: b.map((x) => x.routing.estimatedCost || 0) },
        ]);

        renderChart("chartRouting", [
          { color: "var(--c4)", values: b.map((x) => x.routing.local || 0) },
          { color: "var(--c3)", values: b.map((x) => x.routing.cheap || 0) },
          { color: "var(--c1)", values: b.map((x) => x.routing.premium || 0) },
        ]);

        renderChart("chartPolicy", [
          { color: "var(--c3)", values: b.map((x) => x.policy.allow || 0) },
          { color: "var(--c2)", values: b.map((x) => x.policy.ask || 0) },
          { color: "var(--c1)", values: b.map((x) => x.policy.deny || 0) },
        ]);
      }

      async function refresh() {
        const windowMinutes = Number(els.window.value);
        const bucketMinutes = Number(els.bucket.value);

        const [summary, timeseries] = await Promise.all([
          getJson(`/v1/metrics/summary?windowMinutes=${windowMinutes}`),
          getJson(`/v1/metrics/timeseries?windowMinutes=${windowMinutes}&bucketMinutes=${bucketMinutes}`),
        ]);

        updateSummary(summary);
        updateCharts(timeseries);
        setStatus(`Updated at ${new Date().toLocaleTimeString()} (window ${windowMinutes}m, bucket ${bucketMinutes}m)`);
      }

      function syncRefreshTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        const everyMs = Number(els.refresh.value);
        if (everyMs > 0) {
          timer = setInterval(() => {
            refresh().catch((error) => {
              setStatus(error instanceof Error ? error.message : "refresh failed", true);
            });
          }, everyMs);
        }
      }

      els.refreshBtn.addEventListener("click", () => {
        refresh().catch((error) => {
          setStatus(error instanceof Error ? error.message : "refresh failed", true);
        });
      });

      els.window.addEventListener("change", () => {
        refresh().catch((error) => {
          setStatus(error instanceof Error ? error.message : "refresh failed", true);
        });
      });

      els.bucket.addEventListener("change", () => {
        refresh().catch((error) => {
          setStatus(error instanceof Error ? error.message : "refresh failed", true);
        });
      });

      els.refresh.addEventListener("change", () => {
        syncRefreshTimer();
      });

      els.apiKey.value = localStorage.getItem("controlPlaneApiKey") || "";
      els.apiKey.addEventListener("input", () => {
        localStorage.setItem("controlPlaneApiKey", els.apiKey.value || "");
      });

      syncRefreshTimer();
      refresh().catch((error) => {
        setStatus(error instanceof Error ? error.message : "refresh failed", true);
      });
    </script>
  </body>
</html>
